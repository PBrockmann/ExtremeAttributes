<!DOCTYPE html>
<html>
<!--
 ##########################################################################
 Patrick.Brockmann@lsce.ipsl.fr
 PLEASE DO NOT COPY OR DISTRIBUTE WITHOUT PERMISSION
 ##########################################################################
-->
  <head>
    <meta charset="utf-8">
    <title>Extreme Events Attributes</title>
    <link href="style.css" rel="stylesheet" type="text/css" media="all">
    
    <script src="lib/jquery-1.10.2.min.js"></script>

    <!--Leaflet links-->
    <link rel="stylesheet" href="lib/leaflet-0.7/leaflet.css" />
    <script src="lib/leaflet-0.7/leaflet.js"></script>
    <link rel="stylesheet" href="lib/Leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="lib/Leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="lib/Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
    <script src="lib/Leaflet.Graticule/L.Graticule.js"></script>
    <script src="lib/Leaflet.MousePosition/src/L.Control.MousePosition.js"></script>
    <link rel="stylesheet" href="lib/Leaflet.MousePosition/src/L.Control.MousePosition.css" />
    <script src="lib/Leaflet-MiniMap/src/Control.MiniMap.js"></script>
    <link rel="stylesheet" href="lib/Leaflet-MiniMap/src/Control.MiniMap.css" />

    <!--d3 and dc-->
    <script src="lib/d3.js"></script>
    <script src="lib/crossfilter.js"></script>
    <script src="lib/dc.js-1.6.0/dc.js"></script>
    <link rel="stylesheet" href="lib/dc.js-1.6.0/dc.css" />

    <!--css links-->
    <link href="lib/bootstrap-3.0.2-dist/css/bootstrap.css" rel="stylesheet">
    <script src="lib/bootstrap-3.0.2-dist/js/bootstrap.min.js"></script>
    <!-- Custom styles for this template -->
    <link href="sticky-footer-navbar.css" rel="stylesheet">

    <!--Custom files-->
    <script src="setup.js"></script>
    <!--French admin zones (geoJSON file)-->
    <script src="geojson/FRA_admin_lines_countrybd.geojson" type="text/javascript"></script>
    <!--For d3 map layer -->
    <script src="http://d3js.org/topojson.v1.min.js"></script>

    <style>

      .adminunit {
          fill: #ddc;
          opacity: 0.1,
          
      }

       .place {
          /* fill: #444; */
          fill: #000000;
          stroke: red;
      }

      .place-label {
          /* fill: #444; */
          fill: #8e8e8e;
      }

      text {
          font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
          font-size: 10px;
          pointer-events: none;
      }
    
      svg {
        position: relative;
      }

      path {
        stroke: #A38566;
        stroke-width: 0.5px;
        fill-opacity: .2;
      }
 

    </style>

  </head>

  <body>

    <<div id="map" style="width: 700px; height: 700px"></div>
    <script>

      var width = 960,
          height = 1160;

      var map = L.map('map').setView([47.0, 2.0], 6);
        L.tileLayer(
            'http://services.arcgisonline.com/arcgis/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {  
            attribution: 'LSCE &copy; 2015 | Baselayer &copy; ArcGis',
            maxZoom: 18,
            }).addTo(map);    

      var svg = d3.select(map.getPanes().overlayPane).append("svg"),
            g = svg.append("g").attr("class", "leaflet-zoom-hide");
      

      d3.json("json/FRA_admin_places.json", function(error, admin) {
        if (error) return console.error(error);
        console.log(admin);

        var adminunits = topojson.feature(admin, admin.objects.FRA_admin);
        var bounds = d3.geo.bounds(adminunits);
        var path = d3.geo.path().projection(projectPoint);



        var feature = g.selectAll('.adminunit')
                       .data(topojson.feature(admin, admin.objects.FRA_admin).features)
                       .enter()
                       .append('path')
                       .attr('class', 'adminunit');      

        // var circles = svg.append("path") //g.selectAll('.places')
        //              .datum(topojson.feature(admin, admin.objects.FRA_places))
        //              .attr("d", path)
        //              .attr('class', 'place');

        //admin.objects.FRA_places.geometries.forEach(function(d) {
        //admin.objects.FRA_places.features.forEach(function(d) {  
          // console.log("name:", d.properties.name);
          // console.log("coords: ", d.coordinates);
          // console.log("centroid: ", path.centroid(d));
          // console.log("projectPoint(coords): ", projectPoint(d.coordinates));
          // d.LatLng = new L.LatLng(d.coordinates[0],
          //             d.coordinates[1])
          // console.log(d.LatLng);
        //})

        // var cityMarker = g.selectAll("circle")
        //                .data(admin.objects.FRA_places.geometries)
        //                .enter().append("circle")
        //                 .style("stroke", "black")  
        //                 //.style("opacity", .6) 
        //                 .style("fill", "red")
        //                 .attr("r", 20);   

        var cityMarker = g.selectAll("circle")
                     .data(topojson.feature(admin, admin.objects.FRA_places).features)
                     .enter()
                     .append("circle")
                     .style("stroke", "black")  
                     .style("opacity", .6) 
                     .style("fill", "#8e8e8e")
                     .attr("r", 2);       

        //place labels               
        var places = g.selectAll('.place-label')
                     .data(topojson.feature(admin, admin.objects.FRA_places).features)
                     .enter()
                     .append('text')
                     .attr('class', 'place-label');               

        map.on('viewreset', reset);
        reset();               

      // Reposition the SVG to cover the features.
      function reset() {
        var bottomLeft = projectPoint(bounds[0]),
          topRight = projectPoint(bounds[1]);
   
        svg.attr('width', topRight[0] - bottomLeft[0])
          .attr('height', bottomLeft[1] - topRight[1])
          .style('margin-left', bottomLeft[0] + 'px')
          .style('margin-top', topRight[1] + 'px');
   
        var translation = -bottomLeft[0] + ',' + -topRight[1];
        g.attr('transform', 'translate(' + -bottomLeft[0] + ',' + -topRight[1] + ')');
        
        //feature.attr('d', path);
   
        places.attr('name', function (d) { return d.properties.name; })
          .attr('class', 'place-label')
          .attr('transform', function (d) { 
            console.log("name centroid: ", path.centroid(d));
            return 'translate(' + path.centroid(d) + ')'; })
          .attr('x', -20)
          .attr('dy', '.35em')
          .text(function (d) { return d.properties.name; });

        cityMarker.attr("transform", 
          function(d) { 
            return 'translate(' + path.centroid(d) + ')';
            }
        )
  

        //cityMarkers
        // cityMarker.attr("transform", 
        //   function(d) { 
        //     return "translate("+ 
        //       map.latLngToLayerPoint(d.LatLng).x +","+ 
        //       map.latLngToLayerPoint(d.LatLng).y +")";
        //     }
        // )

       
        
          
      } //end reset()

      // Use Leaflet to implement a D3 geographic projection.
      function projectPoint(x) {
        var point = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
        //console.log(x[1], x[0]);
        return [point.x, point.y];
      }    

    });
    </script>


   <div id="wrap">

      <!-- Fixed navbar -->
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">Extreme Events Attributes</a>
          </div>
          <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
              <li><a href="help.html">Help</a></li>
              <li><a href="contact.html">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>

      <!-- Begin page content -->
      <div class="container">
      	<div class="row">
      		<div id="map" style="width: 600px; height: 700px;"></div>
        </div>
      	<div class="row">
           	    <div id="chart-depth" class="dc-chart col-md-4">
			<span>Depth (m)</span>
			<a class="reset" href="javascript:depthChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
			<span class="reset" style="display: none;"><span class="filter"></span></span>
			<br>
			<br>
           	    </div>
           	     <div id="chart-age" class="dc-chart col-md-4">
             		<span>Oldest age (ka)</span>
			<a class="reset" href="javascript:ageChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
			<span class="reset" style="display: none;"><span class="filter"></span></span>
			<br>
			<br>
           	     </div>
           	     <div id="chart-proxy" class="dc-chart col-md-4">
             		<span>Proxy</span>
			<a class="reset" href="javascript:proxyChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
			<br>
			<span class="reset" style="display: none;"><span class="filter"></span></span>
			<br>
           	     </div>
        </div>
      	<div class="row">
			<div id="totals"><span id="active">-</span> of <span id="total">-</span> proxies selected.</div>
        </div>
      	<div class="row">
      		<div id="proxiesListTitle" class="col-md-12"  style="width: 1000px;"></div>
      		<div id="proxiesList" class="col-md-12" style="width: 1000px; max-height: 160px; overflow-y:auto;"></div>
        </div>
      </div><!-- /.container -->

    </div>

    <div id="footer">
       <div class="container">
       		<p class="text-muted credit">Realised by <span title="Climate and Environment Sciences Laboratory" style="font-weight:bold;">LSCE</span> &nbsp;<img src="LSCE_Icon.png" title="Climate and Environment Sciences Laboratory"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Version 1.3 - 2014/10/29</p>
      </div><!-- /.container -->
    </div>

  </body>
</html>
